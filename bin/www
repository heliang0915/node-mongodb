#!/usr/bin/env node

/**
 * Module dependencies.
 */

var app = require('../app');
var debug = require('debug')('node-mongodb:server');
var http = require('http');
var cluster = require('cluster');
var cpuLen = require('os').cpus().length;
var config = require('../backend/config');
if (cluster.isMaster) {
    var pid = process.pid;
    console.log("主进程启动...");
    console.log('主进程id:' + pid);
    var count=0;
    for (var i = 0; i < cpuLen; i++) {
        cluster.fork();
    }

    cluster.on('listening', function (worker, address) {
        count++;
        console.log('核心' + count + ' pid:' + worker.process.pid);
    });
    count=0;
    cluster.on('exit', function (worker, code, signal) {
        count++;
        console.log('核心' + count + ' pid:' + worker.process.pid + ' 重启');
        setTimeout(function () {
            cluster.fork();
        }, 2000);
    });
    //cluster.kill();
} else {
    app.set('port', process.env.PORT || 3000);
    var server = app.listen(app.get('port'), config.host);
}

